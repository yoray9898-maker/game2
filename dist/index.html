<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>塔防：波次穩定版</title>
    <style>
        body { display: flex; flex-direction: column; align-items: center; background-color: #2c3e50; color: white; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; overflow: hidden; }
        #game-container { position: relative; margin-top: 10px; }
        canvas { background-color: #ecf0f1; border: 5px solid #34495e; border-radius: 8px; cursor: crosshair; }
        
        .ui-panel { margin-top: 10px; padding: 10px 20px; background: #34495e; border-radius: 8px; display: flex; gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 550px; justify-content: space-around; }
        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .label { font-size: 0.8em; color: #bdc3c7; margin-bottom: 2px; }
        .stat { font-size: 1.4em; color: #f1c40f; font-weight: bold; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 610px; height: 410px;
            background: rgba(44, 62, 80, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; z-index: 10;
        }

        .controls { margin-top: 15px; display: flex; gap: 15px; align-items: center; height: 60px; }
        .shop-btn { padding: 10px 15px; cursor: pointer; border: 3px solid transparent; border-radius: 8px; color: white; font-weight: bold; transition: 0.2s; }
        .shop-btn.selected { border-color: #f1c40f; transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        
        #upgradeMenu { background: #8e44ad; padding: 10px 20px; border-radius: 8px; display: none; gap: 15px; align-items: center; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-start { background: #27ae60; color: white; font-size: 1.3em; padding: 12px 30px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>塔防：元素戰爭</h1>

    <div class="ui-panel">
        <div class="stat-box"><span class="label">金錢</span><span id="money" class="stat">150</span></div>
        <div class="stat-box"><span class="label">生命值</span><span id="health" class="stat">10</span></div>
        <div class="stat-box"><span class="label">目前波次</span><span id="wave" class="stat">1</span></div>
        <div class="stat-box"><span class="label">剩餘敵人</span><span id="enemyCount" class="stat">0</span></div>
    </div>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h2 style="color: #f1c40f;">守護基地</h2>
            <p style="text-align: center;">每清完一波，下一波才會開始<br>每 5 波會出現強大 BOSS</p>
            <button class="btn-start" onclick="startGame()">開始遊戲</button>
        </div>
        <div id="game-over-screen" class="overlay hidden">
            <h2 style="color: #e74c3c;">遊戲結束</h2>
            <p id="final-stats" style="font-size: 1.2em; margin-bottom: 20px;"></p>
            <button class="btn-start" onclick="startGame()">重新開始</button>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div class="controls">
        <div id="shop">
            <button class="shop-btn selected" style="background:#2980b9" id="btn-gun" onclick="selectType('gun')">機槍塔 $50</button>
            <button class="shop-btn" style="background:#3498db" id="btn-ice" onclick="selectType('ice')">寒冰塔 $80</button>
            <button class="shop-btn" style="background:#d35400" id="btn-bomb" onclick="selectType('bomb')">砲擊塔 $120</button>
        </div>
        <div id="upgradeMenu">
            <span id="towerInfo" style="font-weight: bold;"></span>
            <button style="background:#f1c40f; color:#2c3e50" onclick="upgradeSelectedTower()">升級 ($<span id="upgradeCost"></span>)</button>
            <button style="background:#bdc3c7; color:#2c3e50" onclick="deselectTower()">取消</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const tileSize = 40;
        
        let money, health, currentWave, enemiesToSpawn, spawnTimer, selectedTower, gameRunning, currentType = 'gun';
        let towers = [], enemies = [], bullets = [];
        let waveInProgress = false; // 新增：判斷當前波次是否正在進行中

        const path = [{x:0,y:1},{x:4,y:1},{x:4,y:4},{x:2,y:4},{x:2,y:6},{x:7,y:6},{x:7,y:2},{x:13,y:2},{x:13,y:5},{x:10,y:5},{x:10,y:7},{x:14,y:7}];
        const mapLayoutOrig = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,1,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,1,1,1,0],[0,0,1,1,1,1,1,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
        let currentMap = [];

        function updateUI() {
            document.getElementById('money').innerText = Math.floor(money);
            document.getElementById('health').innerText = Math.floor(health);
            document.getElementById('wave').innerText = Math.floor(currentWave);
            document.getElementById('enemyCount').innerText = Math.floor(enemies.length + enemiesToSpawn);
        }

        class Enemy {
            constructor(isBoss = false) {
                this.x = path[0].x * tileSize; this.y = path[0].y * tileSize;
                this.targetIndex = 1; this.isBoss = isBoss;
                this.maxHp = Math.floor((isBoss ? 200 : 15) + (currentWave * (isBoss ? 100 : 10)));
                this.hp = this.maxHp;
                this.baseSpeed = isBoss ? 0.6 : (1.2 + Math.random() * 0.8);
                this.speed = this.baseSpeed;
                this.slowTimer = 0;
                this.origColor = isBoss ? '#8e44ad' : (this.baseSpeed > 1.6 ? '#e67e22' : '#c0392b');
            }
            update() {
                if(this.slowTimer > 0) { this.slowTimer--; this.speed = this.baseSpeed * 0.5; } 
                else { this.speed = this.baseSpeed; }
                let target = path[this.targetIndex];
                let dx = target.x * tileSize - this.x, dy = target.y * tileSize - this.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < this.speed) {
                    this.targetIndex++;
                    if(this.targetIndex >= path.length) { health -= this.isBoss ? 5 : 1; this.hp = 0; }
                } else {
                    this.x += (dx/dist) * this.speed; this.y += (dy/dist) * this.speed;
                }
            }
            draw() {
                ctx.fillStyle = '#c0392b'; ctx.fillRect(this.x, this.y - 10, tileSize, 4);
                ctx.fillStyle = this.slowTimer > 0 ? '#3498db' : '#2ecc71';
                ctx.fillRect(this.x, this.y - 10, Math.max(0, tileSize * (this.hp / this.maxHp)), 4);
                ctx.fillStyle = (this.slowTimer > 0) ? '#3498db' : this.origColor;
                ctx.beginPath(); ctx.arc(this.x + 20, this.y + 20, this.isBoss?16:10, 0, Math.PI*2); ctx.fill();
            }
        }

        class Tower {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; this.level = 1; this.cooldown = 0;
                if(type === 'gun') { this.range = 120; this.damage = 8; this.cdMax = 30; this.color = '#2980b9'; }
                if(type === 'ice') { this.range = 100; this.damage = 4; this.cdMax = 40; this.color = '#3498db'; }
                if(type === 'bomb') { this.range = 150; this.damage = 25; this.cdMax = 90; this.color = '#d35400'; }
            }
            upgrade() {
                this.level++; this.range += 15; this.damage = Math.floor(this.damage * 1.5);
                this.cdMax = Math.max(10, Math.floor(this.cdMax * 0.9));
            }
            update() {
                if(this.cooldown > 0) this.cooldown--;
                if(this.cooldown <= 0) {
                    const target = enemies.find(e => Math.hypot((e.x+20)-(this.x+20), (e.y+20)-(this.y+20)) < this.range);
                    if(target) {
                        bullets.push(new Bullet(this.x+20, this.y+20, target, this.damage, this.type));
                        this.cooldown = this.cdMax;
                    }
                }
            }
            draw() {
                ctx.fillStyle = this.color; ctx.fillRect(this.x+4, this.y+4, tileSize-8, tileSize-8);
                ctx.fillStyle = "white"; ctx.font = "bold 10px Arial"; ctx.fillText("Lv"+this.level, this.x+8, this.y+18);
                if(selectedTower === this) {
                    ctx.strokeStyle = "rgba(255, 255, 255, 0.4)"; ctx.setLineDash([5, 5]);
                    ctx.lineWidth = 2; ctx.beginPath();
                    ctx.arc(this.x+20, this.y+20, this.range, 0, Math.PI*2); ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        }

        class Bullet {
            constructor(x, y, target, damage, type) { this.x = x; this.y = y; this.target = target; this.damage = damage; this.type = type; }
            update() {
                let dx = this.target.x+20 - this.x, dy = this.target.y+20 - this.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 8) {
                    if(this.type === 'ice') this.target.slowTimer = 60;
                    if(this.type === 'bomb') {
                        enemies.forEach(e => { if(Math.hypot(e.x - this.target.x, e.y - this.target.y) < 70) e.hp -= this.damage; });
                    } else { this.target.hp -= this.damage; }
                    return true;
                }
                this.x += (dx/dist) * 12; this.y += (dy/dist) * 12;
                return false;
            }
            draw() {
                ctx.fillStyle = this.type === 'ice' ? '#00fbff' : (this.type === 'bomb' ? '#ff6600' : '#f1c40f');
                ctx.beginPath(); ctx.arc(this.x, this.y, this.type==='bomb'?6:3, 0, Math.PI*2); ctx.fill();
            }
        }

        function startGame() {
            money = 150; health = 10; currentWave = 1; towers = []; enemies = []; bullets = []; gameRunning = true;
            waveInProgress = false;
            currentMap = mapLayoutOrig.map(row => [...row]);
            document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden'));
            startNextWave(); 
            gameLoop();
        }

        function startNextWave() {
            enemiesToSpawn = currentWave % 5 === 0 ? 1 : 5 + currentWave * 2;
            spawnTimer = 0;
            waveInProgress = true;
        }

        canvas.addEventListener('mousedown', (e) => {
            if(!gameRunning) return;
            const rect = canvas.getBoundingClientRect();
            const gx = Math.floor((e.clientX - rect.left) / tileSize), gy = Math.floor((e.clientY - rect.top) / tileSize);
            if(gy < 0 || gy >= 10 || gx < 0 || gx >= 15) return;
            const t = towers.find(t => t.x === gx*tileSize && t.y === gy*tileSize);
            if(t) { showUpgrade(t); return; }
            const costs = {gun:50, ice:80, bomb:120};
            if(currentMap[gy][gx] === 0 && money >= costs[currentType]) {
                money -= costs[currentType]; towers.push(new Tower(gx*tileSize, gy*tileSize, currentType));
                currentMap[gy][gx] = 2; deselectTower();
            } else { deselectTower(); }
        });

        function showUpgrade(t) {
            selectedTower = t;
            document.getElementById('shop').style.display = 'none';
            document.getElementById('upgradeMenu').style.display = 'flex';
            document.getElementById('towerInfo').innerText = `${t.type.toUpperCase()} Lv.${t.level}`;
            document.getElementById('upgradeCost').innerText = Math.floor(t.level * 100);
        }

        function deselectTower() {
            selectedTower = null;
            document.getElementById('shop').style.display = 'block';
            document.getElementById('upgradeMenu').style.display = 'none';
        }

        function upgradeSelectedTower() {
            let cost = Math.floor(selectedTower.level * 100);
            if(money >= cost) { money -= cost; selectedTower.upgrade(); showUpgrade(selectedTower); }
        }

        function selectType(t) {
            currentType = t;
            document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('btn-' + t).classList.add('selected');
        }

        function gameLoop() {
            if(!gameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製地圖
            for(let y=0; y<10; y++) for(let x=0; x<15; x++) {
                ctx.fillStyle = currentMap[y][x] === 1 ? '#d35400' : '#27ae60';
                ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
            }

            // 【核心邏輯修改】控制波次增加時機
            if(waveInProgress) {
                if(enemiesToSpawn > 0) {
                    if(++spawnTimer > 45) { 
                        enemies.push(new Enemy(currentWave % 5 === 0)); 
                        enemiesToSpawn--; 
                        spawnTimer = 0; 
                    }
                } else if(enemies.length === 0) {
                    // 這一波清完了！才顯示下一波
                    waveInProgress = false;
                    setTimeout(() => {
                        if(gameRunning) {
                            currentWave++;
                            startNextWave();
                        }
                    }, 1000); // 1秒緩衝時間，讓玩家喘口氣
                }
            }

            updateUI(); 

            // 處理實體
            for(let i=enemies.length-1; i>=0; i--) {
                enemies[i].update(); enemies[i].draw();
                if(enemies[i].hp <= 0) { money += enemies[i].isBoss ? 150 : 20; enemies.splice(i, 1); }
            }
            towers.forEach(t => { t.update(); t.draw(); });
            for(let i=bullets.length-1; i>=0; i--) { if(bullets[i].update()) bullets.splice(i,1); else bullets[i].draw(); }

            if(health <= 0) {
                gameRunning = false;
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('final-stats').innerText = `最終波次：${currentWave}`;
            } else requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
    
  </body>
  
</html>
