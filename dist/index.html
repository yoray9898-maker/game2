<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>元素戰爭：核彈末日 (範圍邏輯最終版)</title>
    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        body { display: flex; flex-direction: column; align-items: center; background-color: #2c3e50; color: white; font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding-top: 15px; overflow: hidden; touch-action: none; }
        .ui-panel { display: flex; justify-content: space-between; background: #34495e; padding: 15px 25px; width: 610px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .stat-box { text-align: center; flex: 1; }
        .label { font-size: 0.85em; color: #bdc3c7; display: block; margin-bottom: 5px; }
        .stat { font-size: 1.2em; font-weight: bold; color: #f1c40f; }
        #game-container { position: relative; width: 612px; height: 412px; }
        canvas { background-color: #ecf0f1; border: 6px solid #34495e; border-radius: 4px; display: block; cursor: crosshair; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: 4px; }
        .diff-btn { width: 300px; padding: 18px; margin: 10px; border: none; border-radius: 15px; color: white; cursor: pointer; text-align: center; transition: transform 0.1s; }
        .diff-btn .title { font-size: 1.4em; font-weight: bold; display: block; margin-bottom: 4px; letter-spacing: 2px; }
        .diff-btn .desc { font-size: 0.8em; opacity: 0.85; display: block; }
        .controls { margin-top: 15px; display: flex; justify-content: space-between; width: 610px; background: #34495e; padding: 10px; border-radius: 4px; gap: 6px; }
        .shop-btn { flex: 1; padding: 10px 2px; cursor: pointer; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8em; text-align: center; transition: 0.2s; position: relative; }
        .shop-btn.selected { border: 2px solid #f1c40f; transform: translateY(-8px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #upgradeMenu { background: #8e44ad; padding: 10px 20px; border-radius: 30px; display: none; gap: 15px; align-items: center; border: 2px solid #f1c40f; margin-top: 15px; width: 610px; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="ui-panel">
        <div class="stat-box"><span class="label">金錢</span><span id="money" class="stat">200</span></div>
        <div class="stat-box"><span class="label">生命值</span><span id="health" class="stat">20</span></div>
        <div class="stat-box"><span class="label">波次</span><span id="waveDisplay" class="stat">1</span></div>
        <div class="stat-box"><span class="label">剩餘敵人</span><span id="enemyCount" class="stat">0</span></div>
    </div>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h2 style="color:#f1c40f; margin-bottom: 25px; font-size: 1.8em;">元素戰爭：核彈末日</h2>
            <button class="diff-btn" style="background:#27ae60;" onclick="startGame(1.25)">
                <span class="title">簡單模式</span>
                <span class="desc">金錢 1.0x / 血量 1.25x</span>
            </button>
            <button class="diff-btn" style="background:#2980b9;" onclick="startGame(1.30)">
                <span class="title">普通模式</span>
                <span class="desc">金錢 1.2x / 血量 1.30x</span>
            </button>
            <button class="diff-btn" style="background:#c0392b;" onclick="startGame(1.40)">
                <span class="title">困難模式</span>
                <span class="desc">金錢 1.4x / 血量 1.40x</span>
            </button>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div id="upgradeMenu">
        <span id="towerInfo" style="font-weight:bold; color:white;"></span>
        <button style="background:#f1c40f; border:none; padding:8px 20px; border-radius:5px; cursor:pointer; font-weight:bold;" onclick="upgradeSelectedTower()">升級 $<span id="upgradeCost"></span></button>
        <button style="background:#EA0000; color:white; border:none; padding:8px 20px; border-radius:5px; cursor:pointer;" onclick="sellSelectedTower()">賣出</button>
        <button style="background:#bdc3c7; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;" onclick="deselectTower()">X</button>
    </div>

    <div class="controls" id="shopControls">
        <button class="shop-btn" id="btn-gun" style="background:#2980b9" onclick="selectType('gun')">機槍 $50</button>
        <button class="shop-btn" id="btn-ice" style="background:#3498db" onclick="selectType('ice')">寒冰 $80</button>
        <button class="shop-btn" id="btn-bomb" style="background:#d35400" onclick="selectType('bomb')">砲擊 $120</button>
        <button class="shop-btn" id="btn-summon" style="background:#f1c40f; color:#2c3e50;" onclick="selectType('summon')">召喚 $150</button>
        <button class="shop-btn" id="btn-trap" style="background:#7f8c8d" onclick="selectType('trap')">陷阱 $150</button>
        <button class="shop-btn" id="btn-nuke" style="background:#c0392b;" onclick="useNuke()">核彈 $500 <br><span id="nukeQty">(擁有: 0)</span></button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let money = 200, health = 20, currentWave = 1, gameRunning = false, nukeCount = 0;
        let towers = [], enemies = [], bullets = [], damageTexts = [], soldiers = [], fieldTraps = [];
        let currentType = null, selectedTower = null, mousePos = {x: -1, y: -1};
        let hpGrowth = 1.3, enemiesToSpawn = 0, spawnTimer = 0, waveInProgress = false;

        const pathPoints = [{x:0,y:1},{x:4,y:1},{x:4,y:4},{x:2,y:4},{x:2,y:6},{x:7,y:6},{x:7,y:2},{x:13,y:2},{x:13,y:5},{x:10,y:5},{x:10,y:7},{x:14,y:7}];
        const mapLayout = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,1,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,1,1,1,0],[0,0,1,1,1,1,1,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
        const roadTiles = []; 
        for(let y=0;y<10;y++) for(let x=0;x<15;x++) if(mapLayout[y][x]===1) roadTiles.push({x,y});

        const towerProps = { 
            gun:[140,25,18,'#2980b9',50,"機槍塔"], 
            ice:[120,15,35,'#3498db',80,"寒冰塔"], 
            bomb:[170,60,65,'#d35400',120,"砲擊塔"], 
            summon:[100,0,180,'#f1c40f',150,"召喚塔"], 
            trap:[100,25,300,'#7f8c8d',150,"陷阱塔"] 
        };

        function startGame(rate) {
            hpGrowth = rate; document.getElementById('start-screen').classList.add('hidden');
            gameRunning = true; waveInProgress = true; enemiesToSpawn = 5;
            selectType('gun'); requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('pointermove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mousePos.x = Math.floor((e.clientX - rect.left) / (rect.width/15));
            mousePos.y = Math.floor((e.clientY - rect.top) / (rect.height/10));
        });

        class Enemy {
            constructor(wave) {
                this.x = pathPoints[0].x*40; this.y = pathPoints[0].y*40; this.tIdx = 1;
                this.maxHp = 100 * Math.pow(hpGrowth, wave-1); this.hp = this.maxHp;
                this.isBoss = wave % 5 === 0; this.baseSpeed = 1.2; this.currentSlow = 0; this.flash = 0;
                this.stun = 0;
            }
            update() {
                if(this.flash > 0) this.flash--;
                if(this.stun > 0) { this.stun--; return; }
                let speed = this.baseSpeed * (1 - this.currentSlow);
                let blocker = soldiers.find(s => Math.hypot(s.x - (this.x+20), s.y - (this.y+20)) < 25);
                if(blocker) { speed = 0; blocker.hp -= 0.5; }
                let target = pathPoints[this.tIdx];
                let dx = target.x*40-this.x, dy = target.y*40-this.y, d = Math.sqrt(dx*dx+dy*dy);
                if(d < 2) { this.tIdx++; if(this.tIdx>=pathPoints.length) { health--; this.hp=0; updateUI(); } }
                else { this.x += (dx/d)*speed; this.y += (dy/d)*speed; }
                this.currentSlow *= 0.96;
            }
            draw() {
                ctx.fillStyle = this.stun > 0 ? "#74b9ff" : (this.currentSlow > 0.1 ? "#81ecec" : (this.isBoss ? "#8e44ad" : "#c0392b"));
                if(this.flash > 0) ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.isBoss?18:12, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black"; ctx.fillRect(this.x+5, this.y-8, 30, 4);
                ctx.fillStyle = "#2ecc71"; ctx.fillRect(this.x+5, this.y-8, 30*(this.hp/this.maxHp), 4);
            }
        }

        function gameLoop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0,600,400);
            for(let y=0;y<10;y++) for(let x=0;x<15;x++) {
                ctx.fillStyle = mapLayout[y][x]===1 ? '#d35400' : '#27ae60'; ctx.fillRect(x*40, y*40, 40, 40);
            }

            // --- 核心範圍顯示邏輯 ---
            if (currentType && !selectedTower && mousePos.x >= 0 && mousePos.y >= 0 && mousePos.y < 10) {
                // 預覽圓圈 (商店購買中)
                const canPlace = mapLayout[mousePos.y][mousePos.x] === 0;
                ctx.beginPath();
                ctx.arc(mousePos.x*40+20, mousePos.y*40+20, towerProps[currentType][0], 0, Math.PI*2);
                ctx.fillStyle = canPlace ? "rgba(255, 255, 255, 0.2)" : "rgba(231, 76, 60, 0.3)";
                ctx.fill();
                ctx.strokeStyle = canPlace ? "rgba(255, 255, 255, 0.5)" : "#e74c3c";
                ctx.stroke();
            } else if(selectedTower) {
                // 固定圓圈 (點擊已放置的塔)
                ctx.beginPath();
                ctx.arc(selectedTower.x+20, selectedTower.y+20, selectedTower.range, 0, Math.PI*2);
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)"; ctx.fill();
                ctx.strokeStyle = "rgba(255, 255, 255, 0.5)"; ctx.lineWidth = 2; ctx.stroke();
            }

            fieldTraps.forEach(ft => {
                ctx.strokeStyle = "#74b9ff"; ctx.lineWidth = 3; ctx.beginPath();
                ctx.arc(ft.x*40+20, ft.y*40+20, 15, 0, Math.PI*2); ctx.stroke();
            });

            if(waveInProgress) {
                if(enemiesToSpawn > 0) {
                    if(++spawnTimer > 60) { enemies.push(new Enemy(currentWave)); enemiesToSpawn--; spawnTimer=0; updateUI(); }
                } else if(enemies.length === 0) {
                    waveInProgress = false;
                    setTimeout(() => { currentWave++; enemiesToSpawn = 5+currentWave; waveInProgress=true; updateUI(); }, 2000);
                }
            }

            towers.forEach(t => {
                ctx.fillStyle = t.color; ctx.fillRect(t.x+2, t.y+2, 36, 36);
                ctx.fillStyle = (t.type === 'summon' || t.type === 'trap') ? "#2c3e50" : "white";
                ctx.font = "bold 11px Arial"; ctx.textAlign = "center";
                ctx.fillText("LV."+t.level, t.x+20, t.y+24);
                
                if(--t.cd <= 0) {
                    if(t.type === 'summon') {
                        let p = pathPoints[Math.floor(Math.random()*(pathPoints.length-2))+1];
                        soldiers.push({x: p.x*40+12, y: p.y*40+12, hp: 50 + t.level*20}); t.cd = t.cdMax;
                    } else if(t.type === 'trap') {
                        let randomTile = roadTiles[Math.floor(Math.random() * roadTiles.length)];
                        fieldTraps.push({x: randomTile.x, y: randomTile.y, dmg: t.dmg, stunTime: 60 + (t.level-1)*30}); 
                        t.cd = Math.max(150, 300 - (t.level-1)*30);
                    } else {
                        let target = enemies.find(e => Math.hypot(e.x+20-(t.x+20), e.y+20-(t.y+20)) < t.range);
                        if(target) { bullets.push({x:t.x+20, y:t.y+20, target, dmg:t.dmg, tower:t}); t.cd = t.cdMax; }
                    }
                }
            });

            fieldTraps = fieldTraps.filter(ft => {
                let hit = enemies.find(e => Math.hypot(e.x+20-(ft.x*40+20), e.y+20-(ft.y*40+20)) < 20);
                if(hit) { hit.hp -= ft.dmg; hit.flash = 5; hit.stun = hit.isBoss ? ft.stunTime/2 : ft.stunTime; return false; }
                return true;
            });

            bullets = bullets.filter(b => {
                let dx = b.target.x+20-b.x, dy = b.target.y+20-b.y, d = Math.sqrt(dx*dx+dy*dy);
                if(d < 15) {
                    if(b.tower.type === 'bomb') enemies.forEach(e => { if(Math.hypot(e.x-b.x, e.y-b.y) < 60) e.hp -= b.dmg; });
                    else { b.target.hp -= b.dmg; if(b.tower.type === 'ice') b.target.currentSlow = 0.6; }
                    b.target.flash = 5; return false;
                }
                b.x += (dx/d)*10; b.y += (dy/d)*10;
                ctx.fillStyle = b.tower.type === 'ice' ? "#81ecec" : "yellow";
                ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
                return b.target.hp > 0;
            });

            damageTexts = damageTexts.filter(t => { t.y -= 1; t.life--; ctx.fillStyle=t.color; ctx.font="bold 14px Arial"; ctx.fillText(t.text, t.x, t.y); return t.life > 0; });
            soldiers = soldiers.filter(s => { s.hp -= 0.1; ctx.fillStyle = "#bdc3c7"; ctx.fillRect(s.x, s.y, 16, 16); return s.hp > 0; });
            enemies = enemies.filter(e => { e.update(); e.draw(); if(e.hp <= 0) { money += 15; if(e.isBoss && Math.random() < 0.5) nukeCount++; updateUI(); } return e.hp > 0; });
            
            if(health <= 0) { alert("遊戲結束！"); location.reload(); }
            requestAnimationFrame(gameLoop);
        }

        function selectType(type) { 
            selectedTower = null; 
            currentType = type; 
            document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected')); 
            document.getElementById('btn-' + type).classList.add('selected'); 
            toggleControls(true);
        }

        function deselectTower() { 
            selectedTower = null; 
            toggleControls(true); 
        }

        function toggleControls(showShop) { 
            document.getElementById('shopControls').classList.toggle('hidden', !showShop); 
            document.getElementById('upgradeMenu').style.display = showShop ? 'none' : 'flex'; 
        }
        
        canvas.addEventListener('pointerup', (e) => {
            const rect = canvas.getBoundingClientRect();
            const px = Math.floor((e.clientX - rect.left) / (rect.width/15));
            const py = Math.floor((e.clientY - rect.top) / (rect.height/10));
            
            const existingTower = towers.find(t => Math.floor(t.x/40) === px && Math.floor(t.y/40) === py);
            
            if(existingTower) {
                // 點擊現有的塔
                selectedTower = existingTower; 
                currentType = null; // 點擊塔時，取消商店購買狀態
                document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
                toggleControls(false); 
                updateUpgradeUI();
            } else if (currentType && mapLayout[py] && mapLayout[py][px] === 0) {
                // 放置新塔
                const cost = towerProps[currentType][4];
                if (money >= cost) {
                    towers.push({ x: px*40, y: py*40, type: currentType, level: 1, range: towerProps[currentType][0], dmg: towerProps[currentType][1], cd: 0, cdMax: towerProps[currentType][2], color: towerProps[currentType][3] });
                    money -= cost; 
                    // 重要：塔放下後，將購買狀態取消，預覽圓圈即消失
                    currentType = null; 
                    document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
                    updateUI();
                } else { 
                    addDmgText(e.clientX - rect.left, e.clientY - rect.top, "金錢不足!", "#e74c3c", 20); 
                }
            } else { 
                deselectTower(); 
            }
        });

        function updateUpgradeUI() { let cost = Math.floor(towerProps[selectedTower.type][4] * Math.pow(1.6, selectedTower.level)); document.getElementById('upgradeCost').innerText = cost; document.getElementById('towerInfo').innerText = towerProps[selectedTower.type][5] + " LV." + selectedTower.level; }
        function upgradeSelectedTower() { let cost = Math.floor(towerProps[selectedTower.type][4] * Math.pow(1.6, selectedTower.level)); if(money >= cost) { money -= cost; selectedTower.level++; selectedTower.dmg *= 1.4; selectedTower.range += 10; updateUI(); updateUpgradeUI(); } }
        function sellSelectedTower() { towers = towers.filter(t => t !== selectedTower); money += Math.floor(towerProps[selectedTower.type][4] * 0.6); updateUI(); deselectTower(); }
        
        function useNuke() { 
            if(nukeCount > 0 && money >= 500) { 
                nukeCount--; money -= 500; 
                enemies.forEach(e => { e.hp -= (e.hp * (e.isBoss ? 0.5 : 0.75)); e.flash = 15; }); 
                updateUI(); addDmgText(300, 200, "核彈發射!!!", "#e74c3c", 40);
            }
        }

        function updateUI() { 
            document.getElementById('money').innerText = money; 
            document.getElementById('health').innerText = health; 
            document.getElementById('waveDisplay').innerText = currentWave; 
            document.getElementById('enemyCount').innerText = enemies.length + enemiesToSpawn;
            document.getElementById('nukeQty').innerText = `(擁有: ${nukeCount})`;
        }

        function addDmgText(x, y, text, color, size) { damageTexts.push({ x, y, text, color, size, life: 40 }); }
    </script>
</body>
</html>
