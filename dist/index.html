<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å…ƒç´ æˆ°çˆ­ï¼šBoss æ‰è½ç‰ˆ</title>
    <style>
        body { margin: 0; background: #2c3e50; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .top-bar { width: 600px; background: #34495e; display: flex; justify-content: space-around; padding: 10px; border-bottom: 3px solid #2c3e50; }
        .stat span { color: #f1c40f; font-weight: bold; font-size: 18px; }
        #game-container { position: relative; width: 600px; height: 400px; border: 4px solid #34495e; overflow: hidden; }
        canvas { background: #567d46; display: block; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44,62,80,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin: 10px; width: 220px; }
        .shop { display: flex; gap: 5px; width: 600px; margin-top: 10px; }
        .shop-btn { flex: 1; padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }
        .shop-btn.selected { outline: 3px solid #f1c40f; }
        #toast { position: absolute; top: 50px; width: 100%; text-align: center; color: #f1c40f; font-weight: bold; display: none; text-shadow: 0 0 10px black; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="stat">ğŸ’°: <span id="money">300</span></div>
    <div class="stat">â¤ï¸: <span id="health">20</span></div>
    <div class="stat">ğŸŒŠ: <span id="wave">1</span></div>
    <div class="stat">â˜¢ï¸: <span id="nuke-count">0</span></div>
</div>

<div id="game-container">
    <div id="toast">â˜¢ï¸ ç²å¾—æ ¸å½ˆï¼</div>
    <div id="menu" class="overlay">
        <h1 style="color:#f1c40f">å…ƒç´ æˆ°çˆ­</h1>
        <button class="btn" style="background:#27ae60" onclick="init(1.0, 1.15, 1.0)">ç°¡å–®æ¨¡å¼</button>
        <button class="btn" style="background:#2980b9" onclick="init(1.2, 1.40, 1.2)">æ™®é€šæ¨¡å¼</button>
        <button class="btn" style="background:#c0392b" onclick="init(1.5, 1.65, 1.4)">å›°é›£æ¨¡å¼</button>
    </div>
    <canvas id="gameCanvas" width="600" height="400"></canvas>
</div>

<div class="shop">
    <button class="shop-btn" id="btn-gun" style="background:#2980b9" onclick="sel('gun')">æ©Ÿæ§ $50</button>
    <button class="shop-btn" id="btn-ice" style="background:#3498db" onclick="sel('ice')">å¯’å†° $80</button>
    <button class="shop-btn" id="btn-bomb" style="background:#d35400" onclick="sel('bomb')">ç ²æ“Š $120</button>
    <button class="shop-btn" style="background:#27ae60" onclick="upg()">å‡ç´šå¡”</button>
    <button class="shop-btn" style="background:#8e44ad" onclick="useNuke()">ç™¼å°„æ ¸å½ˆ (éœ€â˜¢ï¸x1+$500)</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    let money=300, health=20, wave=1, towers=[], enemies=[], bullets=[], selected=null, type=null;
    let active=false, mouse={x:0,y:0,down:false}, dBase=1, dGrowth=1.4, mMult=1, nukeStock=0;

    const path = [{x:0,y:40},{x:160,y:40},{x:160,y:160},{x:80,y:160},{x:80,y:240},{x:280,y:240},{x:280,y:80},{x:520,y:80},{x:520,y:200},{x:400,y:200},{x:400,y:280},{x:600,y:280}];

    function init(b,g,m){ dBase=b; dGrowth=g; mMult=m; document.getElementById('menu').style.display='none'; active=true; spawn(); loop(); }
    function sel(t){ type=t; selected=null; document.querySelectorAll('.shop-btn').forEach(b=>b.classList.remove('selected')); document.getElementById('btn-'+t).classList.add('selected'); }
    function onPath(x, y) {
        for(let i=0; i<path.length-1; i++){
            let p1=path[i], p2=path[i+1], xMin=Math.min(p1.x,p2.x), xMax=Math.max(p1.x,p2.x), yMin=Math.min(p1.y,p2.y), yMax=Math.max(p1.y,p2.y);
            if(x>=xMin && x<=xMax+40 && y>=yMin && y<=yMax+40) return true;
        } return false;
    }

    canvas.onmousedown=(e)=>{ mouse.down=true; updateM(e); let gx=Math.floor(mouse.x/40)*40, gy=Math.floor(mouse.y/40)*40, t=towers.find(t=>t.x===gx&&t.y===gy); if(t){selected=t;type=null;}};
    canvas.onmousemove=(e)=>updateM(e);
    canvas.onmouseup=()=>{
        if(type){
            let gx=Math.floor(mouse.x/40)*40, gy=Math.floor(mouse.y/40)*40, cost=type==='gun'?50:type==='ice'?80:120;
            if(!onPath(gx,gy) && money>=cost && !towers.find(t=>t.x===gx&&t.y===gy)){ money-=cost; towers.push({x:gx,y:gy,type:type,lv:1,cd:0,range:type==='bomb'?170:150}); }
        }
        mouse.down=false; ui();
    };
    function updateM(e){ let r=canvas.getBoundingClientRect(); mouse.x=(e.clientX-r.left)*(canvas.width/r.width); mouse.y=(e.clientY-r.top)*(canvas.height/r.height); }

    function loop(){
        if(!active) return;
        ctx.fillStyle="#567d46"; ctx.fillRect(0,0,600,400); 
        ctx.strokeStyle="#d2b48c"; ctx.lineWidth=40; ctx.lineJoin="round"; ctx.beginPath(); ctx.moveTo(path[0].x+20,path[0].y+20); path.forEach(p=>ctx.lineTo(p.x+20,p.y+20)); ctx.stroke();

        if(mouse.down && type){
            let gx=Math.floor(mouse.x/40)*40, gy=Math.floor(mouse.y/40)*40;
            ctx.beginPath(); ctx.arc(gx+20,gy+20,type==='bomb'?170:150,0,Math.PI*2);
            ctx.strokeStyle=onPath(gx,gy)?"red":"white"; ctx.stroke();
        }
        if(selected){ ctx.beginPath(); ctx.arc(selected.x+20,selected.y+20,selected.range,0,Math.PI*2); ctx.strokeStyle="white"; ctx.stroke(); }

        towers.forEach(t=>{
            ctx.fillStyle=t.type==='gun'?'#2980b9':t.type==='ice'?'#3498db':'#d35400'; ctx.fillRect(t.x+2,t.y+2,36,36);
            if(--t.cd<=0){
                let e=enemies.find(e=>Math.hypot(e.x-t.x,e.y-t.y)<t.range);
                if(e){ bullets.push({x:t.x+20,y:t.y+20,target:e,tower:t}); t.cd=20; }
            }
        });

        bullets=bullets.filter(b=>{
            let dx=b.target.x+20-b.x, dy=b.target.y+20-b.y, d=Math.sqrt(dx*dx+dy*dy);
            if(d<10){ b.target.hp-=(b.tower.type==='gun'?35:b.tower.type==='ice'?10:75)*Math.pow(1.65, b.tower.lv-1); return false; }
            b.x+=(dx/d)*12; b.y+=(dy/d)*12; ctx.fillStyle="yellow"; ctx.fillRect(b.x,b.y,4,4); return b.target.hp>0;
        });

        enemies.forEach(e=>{
            let t=path[e.ti], dx=t.x-e.x, dy=t.y-e.y, d=Math.sqrt(dx*dx+dy*dy);
            if(d<2){ e.ti++; if(e.ti>=path.length){ health--; e.hp=0; } }
            else{ e.x+=(dx/d)*1.2; e.y+=(dy/d)*1.2; }
            ctx.fillStyle=e.boss?"#8e44ad":"#c0392b"; ctx.beginPath(); ctx.arc(e.x+20,e.y+20,e.boss?18:12,0,Math.PI*2); ctx.fill();
            ctx.fillStyle="#555"; ctx.fillRect(e.x,e.y-10,40,5); ctx.fillStyle="lime"; ctx.fillRect(e.x,e.y-10,40*(e.hp/e.mhp),5);
        });

        enemies=enemies.filter(e=>{
            if(e.hp<=0 && e.ti<path.length){ 
                money+=Math.floor((e.boss?400:25)*Math.pow(e.boss?1.15:1.12, wave-1)*mMult);
                if(e.boss && Math.random() < 0.5) { nukeStock++; showToast(); }
                return false; 
            }
            return e.hp>0;
        });

        if(health<=0) location.reload();
        ui(); requestAnimationFrame(loop);
    }

    function spawn(){
        let c=5+wave, boss=(wave%5===0);
        if(boss) enemies.push({x:path[0].x,y:path[0].y,ti:1,boss:true,mhp:100*dBase*Math.pow(dGrowth,wave-1)*15,hp:100*dBase*Math.pow(dGrowth,wave-1)*15});
        else { let i=setInterval(()=>{ if(!active){clearInterval(i);return;} enemies.push({x:path[0].x,y:path[0].y,ti:1,boss:false,mhp:100*dBase*Math.pow(dGrowth,wave-1),hp:100*dBase*Math.pow(dGrowth,wave-1)}); if(--c<=0){clearInterval(i); check();} },800); }
    }
    function check(){ let i=setInterval(()=>{ if(enemies.length===0 && active){clearInterval(i); wave++; setTimeout(spawn,2000);} },1000); }
    function ui(){ document.getElementById('money').innerText=Math.floor(money); document.getElementById('health').innerText=health; document.getElementById('wave').innerText=wave; document.getElementById('nuke-count').innerText=nukeStock; }
    function upg(){ if(selected){ let cost=Math.floor((selected.type==='gun'?50:80)*(selected.lv*1.5)); if(money>=cost){money-=cost; selected.lv++; selected.range+=10; ui();} } }
    function useNuke(){ if(nukeStock > 0 && money >= 500){ money-=500; nukeStock--; enemies.forEach(e=>e.hp*=0.5); ui(); } else { alert("éœ€è¦ 1 æšæ ¸å½ˆåŠ $500ï¼"); } }
    function showToast() { const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
</script>
</body>
</html>
